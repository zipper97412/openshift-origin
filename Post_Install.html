<!DOCTYPE html>
    <html>
    <head>
        <meta http-equiv="Content-type" content="text/html;charset=UTF-8">
        <title>Post install stuff</title>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/katex.min.css" integrity="sha384-9eLZqc9ds8eNjO3TmqPeYcDj8n+Qfa4nuSiGYa6DjLNcv9BtN69ZIulL9+8CqC9Y" crossorigin="anonymous">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Microsoft/vscode/extensions/markdown-language-features/media/markdown.css">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Microsoft/vscode/extensions/markdown-language-features/media/highlight.css">
        <link href="https://cdn.jsdelivr.net/npm/katex-copytex@latest/dist/katex-copytex.min.css" rel="stylesheet" type="text/css">
        <style>
.task-list-item { list-style-type: none; } .task-list-item-checkbox { margin-left: -20px; vertical-align: middle; }
</style>
        <style>
            body {
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe WPC', 'Segoe UI', 'Ubuntu', 'Droid Sans', sans-serif;
                font-size: 14px;
                line-height: 1.6;
            }
        </style>
        
        <script src="https://cdn.jsdelivr.net/npm/katex-copytex@latest/dist/katex-copytex.min.js"></script>
    </head>
    <body>
        <h1 id="post-install-stuff">Post install stuff</h1>
<p>For theses operations you need you need the <code>oc</code> command installed and an administrator access to the cluster.
Download <code>oc</code> here: <a href="https://www.okd.io/download.html#oc-platforms">https://www.okd.io/download.html#oc-platforms</a>
For administrator access:
connect via ssh to a master node (use the ssh keys used for deployment)
OR
login to the cluster with an administrator user</p>
<blockquote>
<p>A Linux terminal is always better but powershell with GNU make and <code>oc</code> should work</p>
</blockquote>
<h2 id="activat-open-id-connect-with-active-directory">Activat Open Id Connect with Active Directory</h2>
<p>Follow this doc: <a href="https://docs.microsoft.com/en-us/azure/virtual-machines/linux/openshift-post-deployment">https://docs.microsoft.com/en-us/azure/virtual-machines/linux/openshift-post-deployment</a></p>
<h2 id="give-administrator-role-to-a-user">Give administrator role to a user</h2>
<p>When connected with a admin account or from a master node:
<code>oc adm policy add-cluster-role-to-user cluster-admin &lt;username&gt;</code>
Replace <code>&lt;username&gt;</code> a htpasswd user or an email address of a AAD user</p>
<p>if htpasswd is used for authentication: <code>oc login -u &lt;username&gt; -p &lt;password&gt;</code>
if Open Id Connect is used for authentication:</p>
<ul>
<li>Go to the web console at <code>https://&lt;master-lb-dns-name&gt;:&lt;api-port(443)&gt;/console</code></li>
<li>Login to your Microsoft account</li>
<li>Click on your name -&gt; Copy Login Command</li>
<li>Paste the command on a terminal</li>
</ul>
<p>Well done, you are logged in as a cluster administrator</p>
<h2 id="install-azure-file-storageclass">Install Azure File <code>StorageClass</code></h2>
<p>Storage classes are used to dynamically create Persistent Volumes for pods.
By default, a storage class with azure disk as backend is used, you can create an other storage class which use azure file (a storage account) as backend.</p>
<ul>
<li>
<p>Persistent Volumes created with azure file can be mounted on different pods, on different nodes but you pay on each read/write operations.</p>
</li>
<li>
<p>Persistent Volumes created with azure disk can only be mounted on pods on the same node but you pay for how long you use it (good for databases) and you have a limited number of disks on each VM (4?)</p>
</li>
<li>
<p>You can reuse the storage account for the registry or create an other one in the cluster resource group, use azure CLI or the web console</p>
</li>
<li>
<p>clone <a href="https://dev.azure.com/infologic-sante/Developpements/_git/OpenShift-templates">https://dev.azure.com/infologic-sante/Developpements/_git/OpenShift-templates</a>
this repository contains some useful deployments for the cluster, it use GNU make and <code>oc</code> to deploy resources</p>
</li>
<li>
<p><code>cd OpenShift-templates/azureFileStorage</code></p>
</li>
<li>
<p>create a file <code>all.yaml.env</code> containing :</p>
</li>
</ul>
<pre><code><div>LOCATION=francecentral
SKU=Standard_LRS
STORAGE_ACCOUNT=&lt;the name of the storage account&gt;
</div></code></pre>
<ul>
<li><code>make apply</code></li>
<li>verify with <code>oc get storageclass azure-file</code></li>
</ul>
<h2 id="install-the-cert-manager">Install the cert-manager</h2>
<p>The Cert Manager is an extension to the openshift API that let you issue new certificates for you applications.
You can install the cert manager along with a certificate issuer global to the cluster signed by infologic-sant√© ROOT CA.</p>
<ul>
<li>clone <a href="https://dev.azure.com/infologic-sante/Developpements/_git/OpenShift-templates">https://dev.azure.com/infologic-sante/Developpements/_git/OpenShift-templates</a></li>
<li><code>cd OpenShift-templates/cert-manager</code></li>
<li>Ask your PKI administrator to create an intermediate ca issuer and give you back the certificate chain in PEM format in a file named <code>ca-issuer.crt</code> and the private key in PEM format without password in a file named <code>ca-issuer.key</code></li>
<li><code>make apply</code></li>
</ul>
<p>If there is no error in the output, the cert manager is installed in the project <code>cert-manager</code>.
In any project you can create <code>Certificate</code> resources like <code>oc apply -f exemple-cert.yaml</code> and the corresponding tls secrets are automatically created ready to use by <code>Ingress</code> resources for exemple (very useful to add https to an http application automagically)</p>
<p>You can manually create other issuers if necessary, follow this doc: <a href="https://docs.cert-manager.io/en/latest/">https://docs.cert-manager.io/en/latest/</a></p>
<h2 id="install-the-choruscloud-operator">Install the ChorusCloud operator</h2>
<p>An operator is an extension to the openshift API that manage the deployments of a complete application.
To simplify, it is a Pod that watch custom resource instances in a project and deploy any necessary components of the application corresponding to the specification of the custom resource instance.</p>
<p>In this case, an operator is used to deploy ChorusCloud instances.
Before that, we need to deploy the operator in a new project via an openshift template,
But first, we need to deploy this template!</p>
<ul>
<li>clone <a href="https://dev.azure.com/infologic-sante/Developpements/_git/OpenShift-templates">https://dev.azure.com/infologic-sante/Developpements/_git/OpenShift-templates</a></li>
<li><code>cd OpenShift-templates/choruscloud-operator</code></li>
<li><code>oc new-project &lt;project name&gt;</code> to create a new project to host the operator and the application instances</li>
<li>The operator build the application from its git repository (azure devops), so it needs a token with read access, you can generate one from azure devops web console. Copy the token in a file named <code>azure-token</code> (no blank/line return!)</li>
<li>The application also needs a <code>p12</code> client certificate to connect to the upstream government API. One for Prod, one for Qualif this certificate is uploaded on the cluster as a <code>Secret</code> resource.
This makefile can upload the qualif certificate, copy here the <code>p12</code> file with the name <code>client.p12</code> and its password in a file named <code>client.p12.password</code> (no blank/line return!), <code>make chorus-cert-qualif.yaml</code> to see the generated secret yaml file</li>
<li><code>make apply</code></li>
</ul>
<p>Now you can deploy the operator in the project from the template with the web console service catalog, <code>oc process</code> command or <code>make apply-operator-instance</code>.
Then you can create many instances of the application by creating <code>ChorusCloud</code> resources in this project ex: <code>make apply-exemple</code>. The operator will make sure that the application is deployed correctly</p>

    </body>
    </html>